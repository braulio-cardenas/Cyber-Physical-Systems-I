<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Image ‚Üí Histogram (Grayscale)</title>
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
  <style>
    body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial;background:#0b0f14;color:#e7eef7}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .controls{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin-bottom:12px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}
    .card{background:#121923;border:1px solid #1e293b;border-radius:12px;padding:12px}
    button{cursor:pointer;border:0;border-radius:8px;padding:8px 12px;font-weight:600;background:#1f2a3a;color:#e7eef7}
    .filename{color:#9fb0c3}
    canvas{display:block;width:100%;height:auto;border-radius:10px}
    #fileInput{position:absolute;left:-9999px;opacity:0;width:0;height:0}
  </style>
</head>
<body>
  <div class="wrap">
    <h2>Image ‚Üí Histogram (grayscale)</h2>

    <div class="controls">
      <input id="fileInput" type="file" accept="image/*" />
      <button id="fileBtn">üìÅ Choose image</button>
      <span id="fileName" class="filename">No image selected</span>

      <button id="btnPlay">‚ñ∂ Play</button>
      <button id="btnStep">Step</button>
      <button id="btnReset">Reset</button>

      <label>Bins <input id="bins" type="range" min="4" max="256" step="1" value="64"></label>
      <output id="binsOut">64</output>

      <label><input id="autoY" type="checkbox" checked/> Auto-rescale Y</label>

      <label>Speed <input id="speed" type="range" min="0.2" max="5" step="0.1" value="1.6"></label>
      <output id="speedOut">1.6√ó</output>

      <label>Scan
        <select id="mode">
          <option value="row" selected>Rows (top ‚Üí bottom)</option>
          <option value="col">Columns (left ‚Üí right)</option>
          <option value="raster">Raster (pixel by pixel)</option>
        </select>
      </label>
    </div>

    <div class="grid">
      <div class="card"><canvas id="imgCanvas" width="640" height="400"></canvas></div>
      <div class="card"><div id="plot" style="width:100%;height:420px"></div></div>
    </div>
  </div>

<script>
const S = {
  img:null, W:640, H:400, bins:64,
  playing:false, row:0, col:0,
  hist:new Array(64).fill(0),
  speed:1.6, autoY:true, mode:'row',
  grayData:null, frameHandle:null
};

// DOM
const canvas = document.getElementById('imgCanvas');
const ctx = canvas.getContext('2d');
const fileInput = document.getElementById('fileInput');
const fileBtn = document.getElementById('fileBtn');
const fileNameLabel = document.getElementById('fileName');
const plotDiv = document.getElementById('plot');
const btnPlay = document.getElementById('btnPlay');
const btnStep = document.getElementById('btnStep');
const btnReset = document.getElementById('btnReset');
const binsRange = document.getElementById('bins');
const binsOut = document.getElementById('binsOut');
const autoYChk = document.getElementById('autoY');
const speedRange = document.getElementById('speed');
const speedOut = document.getElementById('speedOut');
const modeSel = document.getElementById('mode');

// Helpers
const clamp = (v,lo,hi)=>Math.max(lo,Math.min(hi,v));
const toGray = (r,g,b)=> 0.2126*r + 0.7152*g + 0.0722*b; // perceptual
function resizeCanvasToImage(img){ const scale=Math.min(640/img.width,400/img.height,1); S.W=Math.round(img.width*scale); S.H=Math.round(img.height*scale); canvas.width=S.W; canvas.height=S.H; }
function buildGray(){ if(!S.img) return; const off=document.createElement('canvas'); off.width=S.W; off.height=S.H; const g=off.getContext('2d'); g.drawImage(S.img,0,0,S.W,S.H); const id=g.getImageData(0,0,S.W,S.H); const a=id.data; for(let i=0;i<a.length;i+=4){ const y=toGray(a[i],a[i+1],a[i+2])|0; a[i]=a[i+1]=a[i+2]=y; } S.grayData=id; }
function drawGray(){ if(!S.grayData) return; ctx.clearRect(0,0,canvas.width,canvas.height); ctx.putImageData(S.grayData,0,0); }
function drawFrame(){ if(!S.img) return; drawGray(); ctx.save(); ctx.globalAlpha=0.35; ctx.fillStyle = (S.mode==='raster') ? '#ff0000' : '#34d399'; if(S.mode==='row' && S.row<S.H){ const h=Math.max(1,Math.round(S.H*0.02)); ctx.fillRect(0,S.row,S.W,h); } else if(S.mode==='col' && S.col<S.W){ const w=Math.max(1,Math.round(S.W*0.02)); ctx.fillRect(S.col,0,w,S.H); } else if(S.mode==='raster' && S.row<S.H){ const s=Math.max(2, Math.round(Math.min(S.W,S.H)*0.015)); ctx.fillRect(S.col, S.row, s, s); } ctx.restore(); }

// Plot
function initPlot(){ const x=[...Array(S.bins).keys()], y=new Array(S.bins).fill(0); Plotly.newPlot(plotDiv,[{type:'bar',x,y}],{margin:{l:40,r:10,t:10,b:35},paper_bgcolor:'rgba(0,0,0,0)',plot_bgcolor:'rgba(0,0,0,0)',xaxis:{title:'Bin index'},yaxis:{title:'Count',autorange:true},bargap:0.02,showlegend:false},{displayModeBar:false}); }
function resetHistogram(){ S.hist=new Array(S.bins).fill(0); S.row=0; S.col=0; Plotly.restyle(plotDiv,{y:[S.hist]}); drawFrame(); }
function recomputeAll(){ if(!S.img) return; resetHistogram(); if(S.autoY){ Plotly.relayout(plotDiv,{ 'yaxis.autorange':true, 'yaxis.range':null }); } else { const full=new Array(S.bins).fill(0); const d=S.grayData.data; for(let y=0;y<S.H;y++){ for(let x=0;x<S.W;x++){ const i=(y*S.W+x)*4; const b=Math.min(S.bins-1, Math.floor(d[i]/256*S.bins)); full[b]++; }} const ymax=Math.max(8,Math.max(...full)); Plotly.relayout(plotDiv,{ 'yaxis.autorange':false, yaxis:{range:[0,ymax*1.05]} }); } Plotly.restyle(plotDiv,{x:[...Array(S.bins).keys()], y:[S.hist]}); drawFrame(); }

// Animation
function processNextChunk(amount){ if(!S.img) return; const d=S.grayData.data; if(S.mode==='row'){ const rows=clamp(Math.ceil(amount),1,S.H); const y0=S.row, y1=Math.min(S.H,y0+rows); if(y0>=S.H) return; for(let y=y0;y<y1;y++){ for(let x=0;x<S.W;x++){ const i=(y*S.W+x)*4; const b=Math.min(S.bins-1, Math.floor(d[i]/256*S.bins)); S.hist[b]++; }} S.row=y1; } else if(S.mode==='col'){ const cols=clamp(Math.ceil(amount),1,S.W); const x0=S.col, x1=Math.min(S.W,x0+cols); if(x0>=S.W) return; for(let x=x0;x<x1;x++){ for(let y=0;y<S.H;y++){ const i=(y*S.W+x)*4; const b=Math.min(S.bins-1, Math.floor(d[i]/256*S.bins)); S.hist[b]++; }} S.col=x1; } else { // raster
  let n=clamp(Math.ceil(amount),1,S.W*S.H);
  let x=S.col, y=S.row;
  while(n-- > 0 && y<S.H){ const i=(y*S.W+x)*4; const b=Math.min(S.bins-1, Math.floor(d[i]/256*S.bins)); S.hist[b]++; x++; if(x>=S.W){ x=0; y++; } }
  S.col=x; S.row=y;
 }
 if(S.autoY) Plotly.relayout(plotDiv,{ 'yaxis.autorange':true }); Plotly.restyle(plotDiv,{y:[S.hist]}); drawFrame(); }
function tick(){
  if(!S.playing) return;
  let base;
  if(S.mode==='row') base = S.H;
  else if(S.mode==='col') base = S.W;
  else base = S.W * S.H;

  // Raster is intentionally slower so the pixel indicator is visible
  const divisor = (S.mode==='raster') ? 90000 : 90;
  const perTick = Math.max(1, S.speed * Math.max(1, Math.floor(base / divisor)));

  processNextChunk(perTick);
  const done = (S.mode==='row') ? (S.row >= S.H) : (S.mode==='col' ? (S.col >= S.W) : (S.row >= S.H));
  if(done){ S.playing = false; btnPlay.textContent = '‚ñ∂ Play'; return; }

  S.frameHandle = requestAnimationFrame(tick);
}

// Image loading
function loadFromFile(file){ if(!file) return; const reader=new FileReader(); reader.onload=()=>{ const img=new Image(); img.onload=()=>{ S.img=img; S.playing=false; btnPlay.textContent='‚ñ∂ Play'; resizeCanvasToImage(img); buildGray(); drawGray(); recomputeAll(); if(fileNameLabel) fileNameLabel.textContent=file.name||'image'; }; img.src=reader.result; }; reader.readAsDataURL(file); }

// Events
fileBtn.addEventListener('click', ()=> fileInput.click());
fileInput.addEventListener('change', (e)=>{ const f=e.target.files&&e.target.files[0]; if(f){ loadFromFile(f); fileInput.value=''; }});
binsRange.addEventListener('input', ()=>{ S.bins=parseInt(binsRange.value,10); binsOut.textContent=S.bins; S.hist=new Array(S.bins).fill(0); Plotly.restyle(plotDiv,{x:[...Array(S.bins).keys()], y:[S.hist]}); recomputeAll(); });
autoYChk.addEventListener('change', ()=>{ S.autoY=autoYChk.checked; recomputeAll(); });
speedRange.addEventListener('input', ()=>{ S.speed=parseFloat(speedRange.value); speedOut.textContent=S.speed.toFixed(1)+'√ó'; });
modeSel.addEventListener('change', ()=>{ S.mode=modeSel.value; recomputeAll(); });
btnPlay.addEventListener('click', ()=>{ S.playing=!S.playing; btnPlay.textContent=S.playing?'‚è∏ Pause':'‚ñ∂ Play'; if(S.playing){ cancelAnimationFrame(S.frameHandle); tick(); }});
btnStep.addEventListener('click', ()=>{ const base=(S.mode==='row')?S.H:(S.mode==='col'?S.W:S.W*S.H); processNextChunk(Math.max(1,Math.floor(base/40))); });
btnReset.addEventListener('click', ()=>{ S.playing=false; btnPlay.textContent='‚ñ∂ Play'; resetHistogram(); });
window.addEventListener('resize', ()=>{ if(!S.img) return; resizeCanvasToImage(S.img); buildGray(); drawGray(); recomputeAll(); });

// Boot
initPlot();
binsOut.textContent=S.bins;
speedOut.textContent=S.speed.toFixed(1)+'√ó';
</script>
</body>
</html>
